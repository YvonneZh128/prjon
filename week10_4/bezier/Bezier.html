<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
	</head>
	<style type="text/css">
		#input1{
			width: 500px;
			height: 500px;
		}
	</style>
	<body>
		<canvas id="canvas" width="500" height="500"></canvas>
		<input type="checkbox" name="checkpoint" id="checkpoint" value=""/>保留圆圈
		<input type="checkbox" name="checkline" id="checkline" value=""/>保留线
		<input type="button" name="btnDraw" id="btnDraw" value="画贝赛斯曲线" />
		<input type="button" name="btnSave" id="btnSave" value="保存贝赛斯曲线" />
		
		<div id="input1">
			
		</div>
	</body>
	<script src="js/Bezier.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		
		window.onload = function () {
			var btnDraw = document.getElementById("btnDraw");
			var btnSave = document.getElementById("btnSave");
			var checkpoint = document.getElementById("checkpoint");
			var checkline = document.getElementById("checkline");
			
			var canvas = document.getElementById("canvas");
			var paint = canvas.getContext('2d');
			
			var savedArr = [];
			var saveCount = 0;
			var pointArr = [];
			
			init();
			
			btnDraw.onclick = function () {
				if (pointArr.length >= 3) {
					drawBezier(pointArr);
				} else{
					console.log('至少两个点');
				}
			}
			btnSave.onclick = function () {
				savedArr[saveCount] = pointArr;
				pointArr = [];
				console.log(savedArr[0].length)
				saveCount++;
				canvas.onmousedown = mouseDown;
			}
			
			
			canvas.onmousedown = mouseDown;
			
			canvas.oncontextmenu = function (ev) {
				canvas.onmousemove = null;
				canvas.onmousedown = null;
//				restore();
//				drawBezier();

				var e = ev || event;
				var x = Math.round(e.offsetX/20)*20;
				var y = Math.round(e.offsetY/20)*20;
				pointArr.push({x: x, y: y});
				
				paint.beginPath();
				paint.arc(x, y, 10, 0, Math.PI*2, false);
				paint.stroke();
				
				paint.beginPath()
				paint.moveTo(x, y);
				paint.lineTo(pointArr[0].x, pointArr[0].y);
				paint.stroke();
				
				return false;
			}
			
			function init () {
				paint.lineCap = 'round';
			
				drawGirds();
			}
			
			function drawGirds () {
				
				paint.strokeStyle = 'lightgrey';
				paint.lineWidth = 0.5;
				
				for (var i = 0; i <= canvas.width; i=i+20) {
					with (paint){
						paint.beginPath();
						moveTo(i, 0);
						lineTo(i, canvas.height);
						stroke();
					}
				}
				for (var i = 0; i <= canvas.height; i=i+20) {
					with (paint){
						paint.beginPath();
						moveTo(0, i);
						lineTo(canvas.width, i);
						stroke();
					}
				}
			}
			
			function mouseDown (ev) {
				var e = ev || event;
				
				var x = Math.round(e.offsetX/20)*20;
				var y = Math.round(e.offsetY/20)*20;
				var point = {x: x, y: y};
				
				
				if (e.button == 0) {
					paint.strokeStyle = 'black';
					paint.lineWidth = 2;
					paint.beginPath();
					paint.arc(x, y, 10, 0, Math.PI*2, false);
					paint.stroke();
					
					pointArr.push(point);
					
					if (!canvas.onmousemove) {
						canvas.onmousemove = function (ev) {
							restore();
							
							//画两点间的直线
							var e = ev || event;
							var x = Math.round(e.offsetX/20)*20;
							var y = Math.round(e.offsetY/20)*20;
							var originPoint = pointArr[pointArr.length-1];
								
							paint.beginPath();
							paint.moveTo(originPoint.x, originPoint.y);
							paint.lineTo(x, y);
							paint.stroke();
							
						}
					}
				}
				
				if (pointArr.length > 2) {
					var input1 = document.getElementById("input1");
					for (var i = 0; i < pointArr.length-1; i++) {
						var s = '('+pointArr[i].x/20+', '+pointArr[i].y/20+')-'+'('+pointArr[i+1].x/20+', '+pointArr[i+1].y/20+')';
						var e = document.createElement('input');
						e.type = 'checkbox';
						e.checked = 'checked';
						input1.appendChild(e);
						
						var span = document.createElement('span');
						span.innerHTML = s;
						input1.appendChild(span);
					}
				}
				
			}
			
			function restore (flag) {
				paint.clearRect(0, 0, 500, 500);
				
				drawGirds();
				
				paint.strokeStyle = 'black';
				paint.lineWidth = 2;
				if (pointArr.length > 0) {
					if (checkpoint.checked || !flag) {
						paint.beginPath();
						paint.arc(pointArr[0].x, pointArr[0].y, 10, 0, Math.PI*2, false);
						paint.stroke();
					}
				}
				if (pointArr.length > 1) {
					for (var i = 0; i < pointArr.length-1; i++) {
						if (checkline.checked || !flag) {
							paint.beginPath()
							paint.moveTo(pointArr[i].x, pointArr[i].y);
							paint.lineTo(pointArr[i+1].x, pointArr[i+1].y);
							paint.stroke();
						}
						
						if (checkpoint.checked || !flag) {
							paint.beginPath();
							paint.arc(pointArr[i+1].x, pointArr[i+1].y, 10, 0, Math.PI*2, false);
							paint.stroke();
						}
						
					}
				}
				if (flag) {
					if (checkline.checked || !flag) {
						paint.beginPath()
						paint.moveTo(pointArr[pointArr.length-1].x, pointArr[pointArr.length-1].y);
						paint.lineTo(pointArr[0].x, pointArr[0].y);
						paint.stroke();
					}
				}
				if (saveCount > 0) {
					restoreSaved();
				}
			}
			
			function restoreSaved () {
				for (var i = 0; i < saveCount; i++) {
					drawBezier(savedArr[i]);
				}
			}
			
			function drawBezier (pointArr) {
				restore(true);
				
				var children = document.getElementById("input1").querySelectorAll('input');
				//至少三个？
				for (var i = 0; i < pointArr.length; i++) {
					console.log(children.length)
					if (children[i].checked) {
						pointArr[i].enable = true;
						
						var prev = (i - 1 + pointArr.length)%pointArr.length;
						var next = (i + 2)%pointArr.length;
						var j = (i + 1)%	pointArr.length;
						
						var arr = [];
						arr.push(pointArr[prev]);
						arr.push(pointArr[i]);
						arr.push(pointArr[j]);
						arr.push(pointArr[next]);
						
						var controls = Bezier.getControls(arr, 1);
						console.log(controls[0].x+' '+controls[0].y+' '+controls[1].x+' '+controls[1].y)
						paint.beginPath();
						paint.moveTo(pointArr[i].x, pointArr[i].y);
						paint.bezierCurveTo(controls[0].x, controls[0].y, controls[1].x, controls[1].y, pointArr[j].x, pointArr[j].y);
						paint.stroke();
					} else{
						pointArr[i].enable = false;
					}
				}
			}
			
		}
		
		
		
	</script>
</html>
